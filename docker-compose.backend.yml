version: '3.8'

# All Backend Services (Simplified for Coolify)
# Use this if you want to deploy all services together
# Note: This may fail on low-resource servers

services:
  # Core API
  core-api:
    build:
      context: ./services/core-api
      dockerfile: Dockerfile
    container_name: teloo-core-api
    ports:
      - "7002:8000"
    environment:
      - SERVICE_NAME=core-api
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS}
    networks:
      - teloo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Agent IA
  agent-ia:
    build:
      context: ./services/agent-ia
      dockerfile: Dockerfile
    container_name: teloo-agent-ia
    ports:
      - "7003:8000"
    environment:
      - SERVICE_NAME=agent-ia
      - CORE_API_URL=${CORE_API_URL:-http://core-api:8000}
      - REDIS_URL=${REDIS_URL}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - teloo-network
    restart: unless-stopped
    depends_on:
      - core-api

  # Analytics
  analytics:
    build:
      context: ./services/analytics
      dockerfile: Dockerfile
    container_name: teloo-analytics
    ports:
      - "7004:8000"
    environment:
      - SERVICE_NAME=analytics
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - teloo-network
    restart: unless-stopped

  # Realtime Gateway
  realtime-gateway:
    build:
      context: ./services/realtime-gateway
      dockerfile: Dockerfile
    container_name: teloo-realtime
    ports:
      - "7005:8000"
    environment:
      - SERVICE_NAME=realtime-gateway
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - teloo-network
    restart: unless-stopped

  # Files Service
  files:
    build:
      context: ./services/files
      dockerfile: Dockerfile
    container_name: teloo-files
    ports:
      - "7006:8000"
    environment:
      - SERVICE_NAME=files
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - REDIS_URL=${REDIS_URL}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    networks:
      - teloo-network
    restart: unless-stopped

networks:
  teloo-network:
    external: true
