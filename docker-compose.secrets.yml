# Docker Compose with Secrets Support
# This file extends docker-compose.prod.yml with Docker secrets
# Usage: docker-compose -f docker-compose.prod.yml -f docker-compose.secrets.yml up

version: '3.8'

secrets:
  # Database Secrets
  postgres_password:
    file: ./secrets/postgres_password.txt
  
  # Redis Secrets
  redis_password:
    file: ./secrets/redis_password.txt
  
  # MinIO Secrets
  minio_access_key:
    file: ./secrets/minio_access_key.txt
  minio_secret_key:
    file: ./secrets/minio_secret_key.txt
  
  # JWT Secrets
  jwt_secret_key:
    file: ./secrets/jwt_secret_key.txt
  
  # Service Authentication Secrets
  agent_ia_api_key:
    file: ./secrets/agent_ia_api_key.txt
  analytics_api_key:
    file: ./secrets/analytics_api_key.txt
  
  # WhatsApp Secrets
  whatsapp_access_token:
    file: ./secrets/whatsapp_access_token.txt
  whatsapp_verify_token:
    file: ./secrets/whatsapp_verify_token.txt
  whatsapp_webhook_secret:
    file: ./secrets/whatsapp_webhook_secret.txt
  
  # Telegram Secrets
  telegram_bot_token:
    file: ./secrets/telegram_bot_token.txt
  
  # LLM API Secrets
  openai_api_key:
    file: ./secrets/openai_api_key.txt
  anthropic_api_key:
    file: ./secrets/anthropic_api_key.txt
  gemini_api_key:
    file: ./secrets/gemini_api_key.txt
  deepseek_api_key:
    file: ./secrets/deepseek_api_key.txt
  
  # Email/Alert Secrets
  smtp_password:
    file: ./secrets/smtp_password.txt
  slack_webhook_url:
    file: ./secrets/slack_webhook_url.txt

services:
  postgres:
    secrets:
      - postgres_password
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password

  redis:
    secrets:
      - redis_password
    command: >
      sh -c "redis-server --appendonly yes --requirepass $$(cat /run/secrets/redis_password)"

  minio:
    secrets:
      - minio_access_key
      - minio_secret_key
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_access_key
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_secret_key

  core-api:
    secrets:
      - postgres_password
      - redis_password
      - minio_access_key
      - minio_secret_key
      - jwt_secret_key
      - agent_ia_api_key
      - analytics_api_key
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      MINIO_ACCESS_KEY_FILE: /run/secrets/minio_access_key
      MINIO_SECRET_KEY_FILE: /run/secrets/minio_secret_key
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret_key
      AGENT_IA_API_KEY_FILE: /run/secrets/agent_ia_api_key
      ANALYTICS_API_KEY_FILE: /run/secrets/analytics_api_key

  agent-ia:
    secrets:
      - redis_password
      - agent_ia_api_key
      - whatsapp_access_token
      - whatsapp_verify_token
      - whatsapp_webhook_secret
      - telegram_bot_token
      - openai_api_key
      - anthropic_api_key
      - gemini_api_key
      - deepseek_api_key
    environment:
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      SERVICE_API_KEY_FILE: /run/secrets/agent_ia_api_key
      WHATSAPP_ACCESS_TOKEN_FILE: /run/secrets/whatsapp_access_token
      WHATSAPP_VERIFY_TOKEN_FILE: /run/secrets/whatsapp_verify_token
      WHATSAPP_WEBHOOK_SECRET_FILE: /run/secrets/whatsapp_webhook_secret
      TELEGRAM_BOT_TOKEN_FILE: /run/secrets/telegram_bot_token
      OPENAI_API_KEY_FILE: /run/secrets/openai_api_key
      ANTHROPIC_API_KEY_FILE: /run/secrets/anthropic_api_key
      GEMINI_API_KEY_FILE: /run/secrets/gemini_api_key
      DEEPSEEK_API_KEY_FILE: /run/secrets/deepseek_api_key

  analytics:
    secrets:
      - postgres_password
      - redis_password
      - analytics_api_key
      - smtp_password
      - slack_webhook_url
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      SERVICE_API_KEY_FILE: /run/secrets/analytics_api_key
      SMTP_PASSWORD_FILE: /run/secrets/smtp_password
      SLACK_WEBHOOK_URL_FILE: /run/secrets/slack_webhook_url

  realtime-gateway:
    secrets:
      - redis_password
      - jwt_secret_key
    environment:
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      JWT_SECRET_KEY_FILE: /run/secrets/jwt_secret_key

  files:
    secrets:
      - redis_password
      - minio_access_key
      - minio_secret_key
    environment:
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      MINIO_ACCESS_KEY_FILE: /run/secrets/minio_access_key
      MINIO_SECRET_KEY_FILE: /run/secrets/minio_secret_key
